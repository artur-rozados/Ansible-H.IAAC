---
- hosts: Jetsons  # Roda o Playbook em todas as Jetsons
  become: yes

  vars_files:
    - "{{ playbook_dir }}/../../vault.yml"

  tasks:

  - name: Garantir que o Git está instalado
    ansible.builtin.apt:
      name: git 
      state: present # Verifica que o git está instalado, e instala se não estiver
      update_cache: yes
    tags:
      - prerequisites


  - name: Clonar ou atualizar o repositório no diretório home do usuário
    ansible.builtin.git:
      repo: "https://github.com/artur-rozados/Ansible-H.IAAC.git"
      # A MÁGICA ACONTECE AQUI:
      # Constrói o caminho para o diretório home do usuário correto
      # Ex: para jetson1, será /home/jetson1/Ansible-H.IAAC
      dest: "/home/{{ ansible_user }}"
      version: main  # Garante que o repositório está no branch 'main' mais recente
      force: yes     # Força o checkout, descartando alterações locais
      update: yes    # Garante que o 'git pull' será executado se o repo já existir
    # E AQUI TAMBÉM:
    # Executa esta tarefa específica como o usuário correto para cada host
    become_user: "{{ ansible_user }}"
    tags:
      - git